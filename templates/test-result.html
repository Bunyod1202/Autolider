<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ID{{ test.id }} {{ user.text.test_result }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      /* Best-effort screenshot deterrents */
      html, body { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; background:#f6f4fb; }
      img { -webkit-user-drag: none; user-drag: none; }
      /* Watermark + blur */
      #wm-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 1050; opacity: .10; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 120px; }
      .wm-cell { display:flex; align-items:center; justify-content:center; transform: rotate(-24deg); font-weight:700; color:#000; font-size:14px; }
      #blur-overlay { position: fixed; inset: 0; background: rgba(255,255,255,.75); backdrop-filter: blur(6px); z-index: 1100; display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-md-center">
        <div class="col-md-auto">
            <div class="d-flex align-items-center gap-2 mt-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="goBack()">{{ user.text.back }}</button>
              <h1 class="m-0">ID{{ test.id }} {{ user.text.test_result }}</h1>
            </div>
            <hr/>
            <div class="card">
              <div class="card-body">
                <p class="card-text">
                    {{ user.text.theme }} <b>{{ test.theme }}</b><br/>
                    {{ user.text.spent_time }} <b>{{ test.spent_time }}</b><br/>
                    {{ user.text.correct_answers }} <b>{{ test.correct_answers }}</b><br/>
                </p>
                <p class="card-text"><small class="text-muted">{{ test.added_time }}</small></p>
              </div>
            </div>
            <hr/>
            {% for answer in test.answers %}
                <div class="card my-2">
                  {% if answer.quiz.image_url %}
                  <img class="card-img-top" src="{{ answer.quiz.image_url }}" alt="{{ answer.quiz.question }}">
                  {% endif %}
                  <div class="card-body">
                      <h5 class="card-title">{{ answer.quiz.question | safe }}</h5>
                      <hr/>
                      {% for option in answer.quiz.options %}
                      <div class="alert alert-{% if option.id == answer.answer.id and not option.is_correct %}danger{% elif option.is_correct %}success{% else %}light{% endif %}">{{ option.text }}</div>
                      {% endfor %}
                  </div>
                </div>
            {% endfor %}
        </div>
      </div>
    </div>
    <!-- Watermark + Blur overlays -->
    <div id="wm-overlay" aria-hidden="true"></div>
    <div id="blur-overlay" aria-hidden="true"></div>
    <form style="display:none" id="back-form" method="post">
      <input type="hidden" name="user_id" value="{{ test.user_id|default:user.id }}" />
    </form>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const webApp = window.Telegram && window.Telegram.WebApp;
        function goBack(){
          const form = document.getElementById('back-form');
          form.action = "/bot/themes/{{ test.theme_id }}/";
          form.submit();
        }
        if(webApp){
          webApp.expand();
          try{ webApp.BackButton.show(); webApp.BackButton.onClick(goBack);}catch(e){}
        }
        // Best-effort: block context menu, add watermark, blur when hidden
        (function(){
          try { document.addEventListener('contextmenu', function(e){ e.preventDefault(); }, { passive:false }); } catch(e){}
          const wm = document.getElementById('wm-overlay');
          if(wm){
            const text = `User {{ test.user_id|default:user.id }} â€¢ Theme {{ test.theme_id }}`;
            const cells = 40;
            for(let i=0;i<cells;i++){
              const d = document.createElement('div');
              d.className = 'wm-cell';
              d.textContent = text;
              wm.appendChild(d);
            }
          }
          const blur = document.getElementById('blur-overlay');
          function updateBlur(){ blur.style.display = document.hidden ? 'block' : 'none'; }
          document.addEventListener('visibilitychange', updateBlur);
        })();
    </script>
  </body>
</html>
