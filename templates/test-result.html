<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ID{{ test.id }} {{ user.text.test_result }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
     .hiddenOverlay {
       position: fixed;
       inset: 0;
       background: rgba(255,255,255,0.98);
       display: none;
       align-items: center;
       justify-content: center;
       font-size: 20px;
       color: #222;
       z-index: 9999;
       text-align: center;
       padding: 2rem;
       user-select: none;
       -webkit-user-select: none;
       -webkit-touch-callout: none;
     }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-md-center">
        <div class="col-md-auto">
            <div class="d-flex align-items-center gap-2 mt-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="goBack()">{{ user.text.back }}</button>
              <h1 class="m-0">ID{{ test.id }} {{ user.text.test_result }}</h1>
            </div>
            <hr/>
            <div class="card">
              <div class="card-body">
                <p class="card-text">
                    {{ user.text.theme }} <b>{{ test.theme }}</b><br/>
                    {{ user.text.spent_time }} <b>{{ test.spent_time }}</b><br/>
                    {{ user.text.correct_answers }} <b>{{ test.correct_answers }}</b><br/>
                </p>
                <p class="card-text"><small class="text-muted">{{ test.added_time }}</small></p>
              </div>
            </div>
            <hr/>
            {% for answer in test.answers %}
                <div class="card my-2">
                  {% if answer.quiz.image_url %}
                  <img class="card-img-top" src="{{ answer.quiz.image_url }}" alt="{{ answer.quiz.question }}">
                  {% endif %}
                  <div class="card-body">
                      <h5 class="card-title">{{ answer.quiz.question | safe }}</h5>
                      <hr/>
                      {% for option in answer.quiz.options %}
                      <div class="alert alert-{% if option.id == answer.answer.id and not option.is_correct %}danger{% elif option.is_correct %}success{% else %}light{% endif %}">{{ option.text }}</div>
                      {% endfor %}
                  </div>
                </div>
            {% endfor %}
        </div>
      </div>
    </div>
     <div id="overlay" class="hiddenOverlay">ðŸ”’ Secure content hidden</div>
    <form style="display:none" id="back-form" method="post">
      <input type="hidden" name="user_id" value="{{ test.user_id|default:user.id }}" />
    </form>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const webApp = window.Telegram && window.Telegram.WebApp;
        function goBack(){
          const form = document.getElementById('back-form');
          form.action = "/bot/themes/{{ test.theme_id }}/";
          form.submit();
        }
        if(webApp){
          webApp.expand();
          try{ webApp.BackButton.show(); webApp.BackButton.onClick(goBack);}catch(e){}
        }
        // Normalize overlay text in case of encoding issues
        try { document.getElementById('overlay').textContent = 'ðŸ”’ Secure content hidden'; } catch(e){}
         document.addEventListener('visibilitychange', () => {
    const overlay = document.getElementById('overlay');
    if (document.hidden) {
      overlay.style.display = 'flex';
    } else {
      // qaytganda 1 s ga ko'rsatib keyin yo'q qilamiz
      overlay.style.display = 'flex';
      setTimeout(() => { overlay.style.display = 'none'; }, 1000);
    }
  });
  let touchStartTime = 0;
  document.addEventListener('touchstart', (e) => {
    touchStartTime = Date.now();
  }, {passive:true});
  document.addEventListener('touchend', (e) => {
    if (Date.now() - touchStartTime > 600) {
      // uzoq bosish (save image harakati) aniqlandi
      document.getElementById('overlay').style.display = 'flex';
      setTimeout(()=> document.getElementById('overlay').style.display = 'none', 1200);
    }
  });

  // Ctrl+S yoki PrintScreen uchun oddiy ogohlantirish
  window.addEventListener('keydown', (e) => {
    if ((e.ctrlKey && e.key === 's') || e.key === 'PrintScreen') {
      e.preventDefault();
      const overlay = document.getElementById('overlay');
      overlay.style.display = 'flex';
      setTimeout(()=> overlay.style.display = 'none', 900);
    }
  });
    </script>
  </body>
</html>
