{% load text_filters %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ theme.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
      <style>
          body { background: #fff; }
          .header-pill { border-radius: 16px; padding: 6px 12px; }
          .timer-pill { background:#0d6efd; color:#fff; border-radius:16px; padding:6px 12px; font-weight:600; }
          .title-center { text-align:center; font-weight:600; font-size:18px; line-height:1.3; word-break:break-word; }
          .quiz-wrap { background:#ede7ff; border-radius:16px; padding:16px; }

          /* Best-effort screenshot deterrents */
          html, body { 
              -webkit-user-select: none; 
              user-select: none; 
              -webkit-touch-callout: none; 
              -webkit-user-drag: none;
          }
          * {
              -webkit-tap-highlight-color: transparent;
          }
          img { 
              -webkit-user-drag: none; 
              user-drag: none; 
              pointer-events: none;
          }
          .quiz-card-active {
              display: block!important;
          }

          .success { background-color:#22c55e!important; border-color:#22c55e!important; color:#fff!important; }
          .danger  { background-color:#ef4444!important; border-color:#ef4444!important; color:#fff!important; }
          .quiz-btn-active { background-color:#6b7280!important; border-color:#6b7280!important; color:#fff!important; }
          .check-btn {
            border-radius: 16px;
          }
          .back-btn {
            background: #ffffff;
            border: 2px solid #0b5ed7;
            color: #111;
            border-radius: 16px;
          } 
          .btn-success { background-color:#22c55e!important; border-color:#22c55e!important; color:#fff!important; }
          .btn-danger  { background-color:#ef4444!important; border-color:#ef4444!important; color:#fff!important; }
          .quiz-nav .btn { border-radius:10px; min-width:40px; height:36px; display:flex; align-items:center; justify-content:center; font-weight:600; }
          .quiz-nav .btn.btn-light { background:#ede7ff; border-color:#ede7ff; color:#111; } 
          .card_test {
            margin: 85px 0 30px 0;
          }
          /* Option buttons */
          .option-btn { width:100%; border-radius:12px; text-align:left; display:flex; align-items:center; gap:12px; justify-content:flex-start; }
          .option-index { width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:#f1f1f1; color:#333; font-weight:600; }
          /* Bottom nav badges */
          .quiz-nav { background:#ffffff}
          /* Exit modal styling */
          #exitModal .modal-dialog { max-width: 380px; }
          #exitModal .modal-content { border: 0; border-radius: 16px; background: #f2ecff; }
          #exitModal .modal-body { padding: 20px 20px 16px 20px; }
          .btn-pill { border-radius: 999px; padding: 8px 16px; font-weight:600; }
          .btn-soft-secondary { background:#d9d9d9; color:#333; border:0; }
          .btn-soft-secondary:hover { background:#cfcfcf; color:#222; }
          .btn-soft-danger { background:#ff6b6b; color:#fff; border:0; }
          .btn-soft-danger:hover { background:#ff5252; color:#fff; }
          
          /* Navigation scroll improvements */
          .quiz-nav-scroll {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 10px 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
          }
          .quiz-nav-scroll::-webkit-scrollbar {
            display: none;
          }

          /* Screenshot warning modal */
          #screenshotModal .modal-dialog {
            max-width: 380px;
          }
          #screenshotModal .modal-content {
            border: 0;
            border-radius: 16px;
            background: #fff3cd;
            border: 2px solid #ffc107;
          }
          #screenshotModal .modal-body {
            padding: 20px;
            text-align: center;
          }
          #screenshotModal .warning-icon {
            font-size: 48px;
            color: #ffc107;
            margin-bottom: 15px;
          }

          /* Anti-screenshot overlay */
          .screenshot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
            text-align: center;
            padding: 20px;
            flex-direction: column;
          }
          .screenshot-overlay h3 {
            color: #ff6b6b;
            margin-bottom: 20px;
          }
      </style>
  </head>
  <body>
    <!-- Screenshot overlay -->
    <div class="screenshot-overlay" id="screenshotOverlay">
      <div style="font-size: 64px; margin-bottom: 20px;">üö´</div>
      <h3>Skrinshot qilish taqiqlangan!</h3>
      <p style="font-size: 18px; margin-bottom: 10px;">Test tizimi himoyalangan</p>
      <p style="font-size: 16px; opacity: 0.8;">Bu harakat qayd etildi</p>
    </div>

    <div class="fixed-top" id="header" style="background-color: #ffffff;">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between py-3">
                <button type="button" class="btn btn-light back-btn btn-sm check-btn header-pill" onclick="onBackClick()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_23_88)">
                        <path d="M21 11H6.83L10.41 7.41L9 6L3 12L9 18L10.41 16.59L6.83 13H21V11Z" fill="#323232"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_23_88">
                        <rect width="24" height="24" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                    {{ user.text.back }}
                </button>
                <span id="timer" class="timer-pill">00:00:00</span>
            </div>
            <div class="title-center mb-1">{{ theme.name |strip_num_prefix}}</div>
        </div>
    </div>
   
    <div class="container" id="body" style="margin-bottom: 70px;">
    {% for quiz in theme.quizzes %}
            <div class="card_test d-none{% if forloop.first %} quiz-card-active{% endif %}" id="quiz-{{ quiz.id }}" data-answer-id="{{ quiz.answer.id }}">
              <div class="quiz-wrap">
                {% if quiz.image_url %}
                <img class="card-img-top mb-3" style="border-radius:12px;" src="{{ quiz.image_url }}" alt="{{ quiz.question }}">
                {% endif %}
                <h5 class="mb-3 text-center">{{ quiz.question | safe }}</h5>
                {% for option in quiz.options %}
                  <button id="quiz-option-{{ option.id }}" type="button" class="btn btn-light my-2 option-btn" data-quiz-id="{{ quiz.id }}" data-option-id="{{ option.id }}" onclick="selectQuizOption({{ quiz.id }}, {{ option.id}}, {{quiz.answer.id }});">
                    <span class="flex-grow-1">{{ option.text }}</span>
                  </button>
                {% endfor %}
              </div>
            </div>
    {% endfor %}
    </div>

    <div class="fixed-bottom quiz-nav" style="background-color: #ffffff;">
        <div class="container py-3">
            <div class="quiz-nav-scroll" id="quizNavScroll">
                {% for quiz in theme.quizzes %}
                <button id="quiz-{{ quiz.id }}-btn" class="btn btn-light check-btn mx-1{% if forloop.first %} quiz-btn-active{% endif %}" onclick="goToQuiz({{ quiz.id }})">{{ forloop.counter }}</button>
                {% endfor %}
            </div>
        </div>
    </div>

    <form class="d-none" id="form" action="/bot/save-test/" method="post">
        {% csrf_token %}
        <input type="hidden" name="user_id" value="{{ user.id }}"/>
        <input type="hidden" name="theme_id" value="{{ theme.id }}"/>
        <input type="hidden" id="spent_seconds" name="spent_seconds" value="0"/>
        <input type="hidden" id="selected_options" name="selected_options" value=""/>
    </form>

    <!-- Exit/Continue Modal -->
    <div class="modal fade" id="exitModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <p class="mb-3">{{ user.text.are_you_sure|default:"Chiqmoqchimisiz? Saqlab, keyin davom ettirishingiz mumkin." }}</p>
            <div class="d-flex justify-content-center gap-2">
              <button type="button" class="btn btn-soft-secondary btn-pill" data-bs-dismiss="modal" onclick="resumeTimer()">{{ user.text.continue_label|default:"Davom etish" }}</button>
              <button type="button" class="btn btn-soft-danger btn-pill" onclick="confirmExit()">{{ user.text.exit_label|default:"Chiqish" }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Screenshot Warning Modal -->
    <div class="modal fade" id="screenshotModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <h5 class="text-center mb-3">Skrinshot qilish taqiqlangan!</h5>
            <p class="text-center mb-3">Test natijalari sizning shaxsiy profilingizga saqlanadi. Skrinshot qilish test natijalariga ta'sir qilishi mumkin.</p>
            <div class="d-flex justify-content-center">
              <button type="button" class="btn btn-warning btn-pill" data-bs-dismiss="modal">Tushunarli</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const webApp = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (webApp) { try { webApp.expand(); } catch(e) {} }

        document.getElementById('body').style.marginTop = document.getElementById('header').offsetHeight + "px";

        const quizzes_count = {{ theme.quizzes_count }};
        const quizIds = [
            {% for quiz in theme.quizzes %}{{ quiz.id }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        let seconds = 0;
        let timerId = null;
        const stateKey = `test_state_{{ user.id }}_{{ theme.id }}`;

        // Screenshot detection variables
        let screenshotWarningShown = false;
        let lastVisibilityChange = Date.now();
        let volumeButtonsPressed = false;
        let powerButtonPressed = false;
        let buttonPressTimer = null;

        function startTimer(){
            if(timerId !== null) return;
            timerId = setInterval(() => {
                seconds++;
                renderTimer();
                persistState();
            }, 1000);
        }
        
        function stopTimer(){
            if(timerId !== null){
                clearInterval(timerId);
                timerId = null;
            }
        }
        
        function renderTimer(){
            const timer = document.getElementById('timer');
            timer.innerHTML = pad(parseInt(seconds / 3600)) + ":" + pad(parseInt((seconds % 3600) / 60)) + ":" + pad(seconds%60);
        }
        startTimer();

        function pad(val) {
          var valString = val + "";
          if (valString.length < 2) {
            return "0" + valString;
          } else {
            return valString;
          }
        }

        function goToQuiz(quiz_id){
            document.getElementsByClassName('quiz-card-active')[0].classList.remove('quiz-card-active');
            document.getElementsByClassName('quiz-btn-active')[0].classList.remove('quiz-btn-active');
            document.getElementById('quiz-' + quiz_id).classList.add('quiz-card-active');
            document.getElementById('quiz-' + quiz_id + '-btn').classList.add('quiz-btn-active');
            
            centerActiveButton();
            persistState({ current_quiz_id: quiz_id });
        }

        function goToNextQuiz(){
            const currentId = getCurrentQuizId();
            if(currentId === null) return;
            const idx = quizIds.indexOf(currentId);
            if(idx >= 0 && idx < quizIds.length - 1){
                goToQuiz(quizIds[idx + 1]);
            }
        }

        function goToPrevQuiz(){
            const currentId = getCurrentQuizId();
            if(currentId === null) return;
            const idx = quizIds.indexOf(currentId);
            if(idx > 0){
                goToQuiz(quizIds[idx - 1]);
            }
        }

        function centerActiveButton() {
            const navScroll = document.getElementById('quizNavScroll');
            const activeButton = document.querySelector('.quiz-btn-active');
            
            if (activeButton && navScroll) {
                const containerWidth = navScroll.offsetWidth;
                const buttonOffset = activeButton.offsetLeft;
                const buttonWidth = activeButton.offsetWidth;
                
                const scrollPosition = buttonOffset - (containerWidth / 2) + (buttonWidth / 2);
                
                navScroll.scrollTo({
                    left: scrollPosition,
                    behavior: 'smooth'
                });
            }
        }

        let selected_options = [];

        function selectQuizOption(quiz_id, option_id, answer_id){
            if(!selected_options.includes(option_id)){
                selected_options.push(option_id);
            }
            applySelection(quiz_id, option_id, answer_id);
            persistState();
            if(selected_options.length === quizzes_count){
                clearState();
                document.getElementById('spent_seconds').value = seconds;
                document.getElementById('selected_options').value = selected_options.join(',');
                document.getElementById('form').submit()
            }
        }

        function applySelection(quiz_id, option_id, answer_id){
            if(option_id === answer_id){
                document.getElementById('quiz-option-' + option_id).classList.remove('btn-light');
                document.getElementById('quiz-option-' + option_id).classList.add('btn-success');
                document.getElementById('quiz-' + quiz_id + '-btn').classList.add('success');
            }else{
                document.getElementById('quiz-option-' + option_id).classList.remove('btn-light');
                document.getElementById('quiz-option-' + option_id).classList.add('btn-danger');
                document.getElementById('quiz-option-' + answer_id).classList.remove('btn-light');
                document.getElementById('quiz-option-' + answer_id).classList.add('btn-success');
                document.getElementById('quiz-' + quiz_id + '-btn').classList.add('danger');
            }
            for(var b of document.getElementById('quiz-' + quiz_id).getElementsByTagName('button')){
                b.removeAttribute('onclick');
            }
        }

        function getCurrentQuizId(){
            const active = document.getElementsByClassName('quiz-card-active')[0];
            if(!active) return null;
            const id = active.id.replace('quiz-','');
            return parseInt(id);
        }

        function persistState(extra){
            const current_quiz_id = extra && extra.current_quiz_id ? extra.current_quiz_id : getCurrentQuizId();
            const state = {
                seconds,
                current_quiz_id,
                selected_options,
            };
            try { localStorage.setItem(stateKey, JSON.stringify(state)); } catch(e) {}
        }

        function restoreState(){
            try {
                const raw = localStorage.getItem(stateKey);
                if(!raw) return;
                const state = JSON.parse(raw);
                if(state.seconds){ seconds = state.seconds; renderTimer(); }
                if(Array.isArray(state.selected_options)){
                    selected_options = state.selected_options;
                    for(const optId of selected_options){
                        const btn = document.getElementById('quiz-option-' + optId);
                        if(!btn) continue;
                        const qid = parseInt(btn.getAttribute('data-quiz-id'));
                        const ansId = parseInt(document.getElementById('quiz-' + qid).getAttribute('data-answer-id'));
                        applySelection(qid, optId, ansId);
                    }
                }
                if(state.current_quiz_id){ 
                    goToQuiz(state.current_quiz_id);
                    setTimeout(centerActiveButton, 100);
                }
                if(Array.isArray(selected_options) && selected_options.length === quizzes_count){
                    clearState();
                    document.getElementById('spent_seconds').value = seconds;
                    document.getElementById('selected_options').value = selected_options.join(',');
                    document.getElementById('form').submit();
                }
            } catch(e) {}
        }

        function clearState(){
            try {
                localStorage.removeItem(stateKey);
                const prefix = `test_state_{{ user.id }}_`;
                const toRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(prefix)) toRemove.push(k);
                }
                for (const k of toRemove) localStorage.removeItem(k);
            } catch(e) {}
        }

        // KUCHLI TELEFON SKRINSHOT HIMOYASI
        function initAdvancedScreenshotProtection() {
            // 1. Hardware button combination detection
            let volumeDownPressed = false;
            let volumeUpPressed = false;
            let powerPressed = false;
            let combinationTimer = null;

            // Hardware button event listeners
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case 'VolumeDown':
                        volumeDownPressed = true;
                        checkButtonCombination();
                        break;
                    case 'VolumeUp':
                        volumeUpPressed = true;
                        checkButtonCombination();
                        break;
                    case 'Power':
                        powerPressed = true;
                        checkButtonCombination();
                        break;
                }
                
                // Clear flags after 2 seconds
                if (combinationTimer) clearTimeout(combinationTimer);
                combinationTimer = setTimeout(() => {
                    volumeDownPressed = false;
                    volumeUpPressed = false;
                    powerPressed = false;
                }, 2000);
            });

            document.addEventListener('keyup', function(e) {
                switch(e.key) {
                    case 'VolumeDown':
                        volumeDownPressed = false;
                        break;
                    case 'VolumeUp':
                        volumeUpPressed = false;
                        break;
                    case 'Power':
                        powerPressed = false;
                        break;
                }
            });

            function checkButtonCombination() {
                // Volume Down + Power (Android)
                if ((volumeDownPressed && powerPressed) || 
                    (volumeUpPressed && powerPressed) ||
                    // Volume Down + Volume Up (some devices)
                    (volumeDownPressed && volumeUpPressed)) {
                    triggerScreenshotProtection();
                }
            }

            // 2. Page visibility and blur detection
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    const now = Date.now();
                    if (now - lastVisibilityChange < 500) {
                        triggerScreenshotProtection();
                    }
                    lastVisibilityChange = now;
                }
            });

            window.addEventListener('blur', function() {
                setTimeout(() => {
                    if (!document.hasFocus()) {
                        triggerScreenshotProtection();
                    }
                }, 50);
            });

            // 3. Resize and orientation changes
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    triggerScreenshotProtection();
                }, 100);
            });

            // 4. Multi-touch detection (3+ fingers)
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length >= 3) {
                    triggerScreenshotProtection();
                }
            });

            // 5. Prevent context menu and text selection
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                triggerScreenshotProtection();
                return false;
            });

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });

            // 6. Periodic security checks
            setInterval(() => {
                // Check for unusual window state
                if (window.outerHeight - window.innerHeight > 300 || 
                    window.outerWidth - window.innerWidth > 300) {
                    triggerScreenshotProtection();
                }
            }, 500);

            // 7. Add visual protection
            addVisualProtection();
        }

        function addVisualProtection() {
            // Add protective overlay that appears in screenshots
            const style = document.createElement('style');
            style.textContent = `
                .anti-screenshot::before {
                    content: 'TEST HIMOYALANGAN';
                    position: fixed;
                    top: 10px;
                    left: 10px;
                    background: rgba(255,0,0,0.8);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                    z-index: 10000;
                    pointer-events: none;
                }
                
                @media screen and (max-width: 768px) {
                    body::after {
                        content: '';
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: repeating-linear-gradient(
                            45deg,
                            transparent,
                            transparent 10px,
                            rgba(255,0,0,0.05) 10px,
                            rgba(255,0,0,0.05) 20px
                        );
                        pointer-events: none;
                        z-index: 9998;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Add anti-screenshot class to body
            document.body.classList.add('anti-screenshot');
        }

        function triggerScreenshotProtection() {
            if (screenshotWarningShown) return;
            
            screenshotWarningShown = true;
            
            // Show aggressive overlay immediately
            showScreenshotOverlay();
            
            // Show modal warning
            setTimeout(() => {
                const modal = new bootstrap.Modal(document.getElementById('screenshotModal'));
                modal.show();
            }, 500);
            
            // Log the attempt (you can send this to your server)
            console.log('Screenshot attempt detected at:', new Date().toISOString());
            
            // Reset flag after 5 seconds
            setTimeout(() => {
                hideScreenshotOverlay();
                screenshotWarningShown = false;
            }, 5000);

            // Reset when modal is closed
            document.getElementById('screenshotModal').addEventListener('hidden.bs.modal', function() {
                screenshotWarningShown = false;
            });
        }

        function showScreenshotOverlay() {
            const overlay = document.getElementById('screenshotOverlay');
            overlay.style.display = 'flex';
            
            // Add some animation
            overlay.style.animation = 'fadeIn 0.3s ease-in';
        }

        function hideScreenshotOverlay() {
            const overlay = document.getElementById('screenshotOverlay');
            overlay.style.display = 'none';
        }

        // Back handling
        function onBackClick(){
            stopTimer();
            const modal = new bootstrap.Modal(document.getElementById('exitModal'));
            modal.show();
        }
        
        function resumeTimer(){
            startTimer();
        }
        
        function confirmExit(){
            stopTimer();
            persistState();
            const form = document.createElement('form');
            form.style.display = 'none';
            form.method = 'post';
            form.action = '/bot/themes/{{ theme.id }}/';
            const uid = document.createElement('input');
            uid.type = 'hidden';
            uid.name = 'user_id';
            uid.value = '{{ user.id }}';
            form.appendChild(uid);
            document.body.appendChild(form);
            form.submit();
        }

        // Telegram native back button
        if (webApp) { try { webApp.BackButton.show(); webApp.BackButton.onClick(onBackClick); } catch(e) {} }

        // Initialize advanced screenshot protection
        initAdvancedScreenshotProtection();

        // Restore previous state if any
        restoreState();

        // Center active button on window resize
        window.addEventListener('resize', centerActiveButton);

        // Swipe navigation between quizzes (mobile)
        (function(){
            const el = document.getElementById('body');
            if(!el) return;
            let startX = 0, startY = 0;
            el.addEventListener('touchstart', function(e){
                if(!e.changedTouches || !e.changedTouches[0]) return;
                startX = e.changedTouches[0].clientX;
                startY = e.changedTouches[0].clientY;
            }, { passive: true });
            el.addEventListener('touchend', function(e){
                if(!e.changedTouches || !e.changedTouches[0]) return;
                const dx = e.changedTouches[0].clientX - startX;
                const dy = e.changedTouches[0].clientY - startY;
                if(Math.abs(dx) > 60 && Math.abs(dy) < 50){
                    if(dx < 0){
                        goToNextQuiz();
                    } else {
                        goToPrevQuiz();
                    }
                }
            }, { passive: true });
        })();

        if (webApp) { try { webApp.enableClosingConfirmation(); } catch(e) {} }

        // Add CSS animation for overlay
        const animationStyle = document.createElement('style');
        animationStyle.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(animationStyle);
    </script>
  </body>
</html>