<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ theme.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
      <style>

          body { background: #fff; }
          .header-pill { border-radius: 16px; padding: 6px 12px; }
          .timer-pill { background:#0d6efd; color:#fff; border-radius:16px; padding:6px 12px; font-weight:600; }
          .title-center { text-align:center; font-weight:600; font-size:18px; line-height:1.3; word-break:break-word; }
          .quiz-wrap { background:#ede7ff; border-radius:16px; padding:16px; }

          /* Best-effort screenshot deterrents */
          html, body { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
          img { -webkit-user-drag: none; user-drag: none; }
          .quiz-card-active {
              display: block!important;
          }

          .quiz-btn-active { background-color:#6b7280!important; border-color:#6b7280!important; color:#fff!important; }

          .success { background-color:#22c55e!important; border-color:#22c55e!important; color:#fff!important; }
          .danger  { background-color:#ef4444!important; border-color:#ef4444!important; color:#fff!important; }
          .check-btn {
            border-radius: 16px;
          }
          .back-btn {
            background: #ffffff;
            border: 2px solid #0b5ed7;
            color: #111;
            border-radius: 16px;
          } 
          .btn-success { background-color:#22c55e!important; border-color:#22c55e!important; color:#fff!important; }
          .btn-danger  { background-color:#ef4444!important; border-color:#ef4444!important; color:#fff!important; }
          .quiz-nav .btn { border-radius:10px; min-width:40px; height:36px; display:flex; align-items:center; justify-content:center; font-weight:600; }
          .quiz-nav .btn.btn-light { background:#ede7ff; border-color:#ede7ff; color:#111; } 
          .card_test {
            margin: 85px 0 30px 0;
          }
          /* Option buttons */
          .option-btn { width:100%; border-radius:12px; text-align:left; display:flex; align-items:center; gap:12px; justify-content:flex-start; }
          .option-index { width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:#f1f1f1; color:#333; font-weight:600; }
          /* Bottom nav badges */
          .quiz-nav { background:#ffffff}
          /* Exit modal styling */
          #exitModal .modal-dialog { max-width: 380px; }
          #exitModal .modal-content { border: 0; border-radius: 16px; background: #f2ecff; }
          #exitModal .modal-body { padding: 20px 20px 16px 20px; }
          .btn-pill { border-radius: 999px; padding: 8px 16px; font-weight:600; }
          .btn-soft-secondary { background:#d9d9d9; color:#333; border:0; }
          .btn-soft-secondary:hover { background:#cfcfcf; color:#222; }
          .btn-soft-danger { background:#ff6b6b; color:#fff; border:0; }
          .btn-soft-danger:hover { background:#ff5252; color:#fff; }
      </style>
  </head>
  <body>
    <div class="fixed-top" id="header" style="background-color: #ffffff;">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between py-3">
                <button type="button" class="btn btn-light back-btn btn-sm check-btn header-pill" onclick="onBackClick()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_23_88)">
<path d="M21 11H6.83L10.41 7.41L9 6L3 12L9 18L10.41 16.59L6.83 13H21V11Z" fill="#323232"/>
</g>
<defs>
<clipPath id="clip0_23_88">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>
</svg>
 {{ user.text.back }}</button>
              
                <span id="timer" class="timer-pill">00:00:00</span>
            </div>
              <div class="title-center  mb-1">{{ theme.name|strip_num_prefix }}</div>
        </div>
    </div>
   
    <div class="container" id="body" style="margin-bottom: 70px;">
    {% for quiz in theme.quizzes %}
        <div class="card_test d-none{% if forloop.first %} quiz-card-active{% endif %}" id="quiz-{{ quiz.id }}" data-answer-id="{{ quiz.answer.id }}">
          <div class="quiz-wrap">
            {% if quiz.image_url %}
            <img class="card-img-top mb-3" style="border-radius:12px;" src="{{ quiz.image_url }}" alt="{{ quiz.question }}">
            {% endif %}
            <h5 class="mb-3 text-center">{{ quiz.question | safe }}</h5>
            {% for option in quiz.options %}
              <button id="quiz-option-{{ option.id }}" type="button" class="btn btn-light my-2 option-btn" data-quiz-id="{{ quiz.id }}" data-option-id="{{ option.id }}" onclick="selectQuizOption({{ quiz.id }}, {{ option.id}}, {{quiz.answer.id }});">
                <!-- <span class="option-index">{{ forloop.counter }}</span> -->
                <span class="flex-grow-1">{{ option.text }}</span>
              </button>
            {% endfor %}
          </div>
        </div>
    {% endfor %}
    </div>
    <div class="fixed-bottom quiz-nav" style="background-color: #ffffff;">
        <div class="container py-3">
            <div class="overflow-scroll d-flex">
                {% for quiz in theme.quizzes %}
                <button id="quiz-{{ quiz.id }}-btn" class="btn btn-light check-btn mx-1{% if forloop.first %} quiz-btn-active{% endif %}" onclick="goToQuiz({{ quiz.id }})">{{ forloop.counter }}</button>
                {% endfor %}
            </div>
        </div>
    </div>
    <form class="d-none" id="form" action="/bot/save-test/" method="post">
        {% csrf_token %}
        <input type="hidden" name="user_id" value="{{ user.id }}"/>
        <input type="hidden" name="theme_id" value="{{ theme.id }}"/>
        <input type="hidden" id="spent_seconds" name="spent_seconds" value="0"/>
        <input type="hidden" id="selected_options" name="selected_options" value=""/>
    </form>

    <!-- Exit/Continue Modal (restyled) -->
    <div class="modal fade" id="exitModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <p class="mb-3">{{ user.text.are_you_sure|default:"Chiqmoqchimisiz? Saqlab, keyin davom ettirishingiz mumkin." }}</p>
            <div class="d-flex justify-content-center gap-2">
              <button type="button" class="btn btn-soft-secondary btn-pill" data-bs-dismiss="modal" onclick="resumeTimer()">{{ user.text.continue_label|default:"Davom etish" }}</button>
              <button type="button" class="btn btn-soft-danger btn-pill" onclick="confirmExit()">{{ user.text.exit_label|default:"Chiqish" }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const webApp = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (webApp) { try { webApp.expand(); } catch(e) {} }

        document.getElementById('body').style.marginTop = document.getElementById('header').offsetHeight + "px";

        const quizzes_count = {{ theme.quizzes_count }};
        const quizIds = [
            {% for quiz in theme.quizzes %}{{ quiz.id }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        let seconds = 0;
        let timerId = null;
        const stateKey = `test_state_{{ user.id }}_{{ theme.id }}`;

        function startTimer(){
            if(timerId !== null) return;
            timerId = setInterval(() => {
                seconds++;
                renderTimer();
                persistState();
            }, 1000);
        }
        function stopTimer(){
            if(timerId !== null){
                clearInterval(timerId);
                timerId = null;
            }
        }
        function renderTimer(){
            const timer = document.getElementById('timer');
            timer.innerHTML = pad(parseInt(seconds / 3600)) + ":" + pad(parseInt((seconds % 3600) / 60)) + ":" + pad(seconds%60);
        }
        startTimer();

        function pad(val) {
          var valString = val + "";
          if (valString.length < 2) {
            return "0" + valString;
          } else {
            return valString;
          }
        }

        function goToQuiz(quiz_id){
            document.getElementsByClassName('quiz-card-active')[0].classList.remove('quiz-card-active');
            document.getElementsByClassName('quiz-btn-active')[0].classList.remove('quiz-btn-active');
            document.getElementById('quiz-' + quiz_id).classList.add('quiz-card-active');
            document.getElementById('quiz-' + quiz_id + '-btn').classList.add('quiz-btn-active');
            persistState({ current_quiz_id: quiz_id });
        }

        function goToNextQuiz(){
            const currentId = getCurrentQuizId();
            if(currentId === null) return;
            const idx = quizIds.indexOf(currentId);
            if(idx >= 0 && idx < quizIds.length - 1){
                goToQuiz(quizIds[idx + 1]);
            }
        }

        function goToPrevQuiz(){
            const currentId = getCurrentQuizId();
            if(currentId === null) return;
            const idx = quizIds.indexOf(currentId);
            if(idx > 0){
                goToQuiz(quizIds[idx - 1]);
            }
        }

        let selected_options = [];

        function selectQuizOption(quiz_id, option_id, answer_id){
            if(!selected_options.includes(option_id)){
                selected_options.push(option_id);
            }
            applySelection(quiz_id, option_id, answer_id);
            persistState();
            if(selected_options.length === quizzes_count){
                clearState();
                document.getElementById('spent_seconds').value = seconds;
                document.getElementById('selected_options').value = selected_options.join(',');
                document.getElementById('form').submit()
            }
        }

        function applySelection(quiz_id, option_id, answer_id){
            if(option_id === answer_id){
                document.getElementById('quiz-option-' + option_id).classList.remove('btn-light');
                document.getElementById('quiz-option-' + option_id).classList.add('btn-success');
                document.getElementById('quiz-' + quiz_id + '-btn').classList.add('success');
            }else{
                document.getElementById('quiz-option-' + option_id).classList.remove('btn-light');
                document.getElementById('quiz-option-' + option_id).classList.add('btn-danger');
                document.getElementById('quiz-option-' + answer_id).classList.remove('btn-light');
                document.getElementById('quiz-option-' + answer_id).classList.add('btn-success');
                document.getElementById('quiz-' + quiz_id + '-btn').classList.add('danger');
            }
            for(var b of document.getElementById('quiz-' + quiz_id).getElementsByTagName('button')){
                b.removeAttribute('onclick');
            }
        }

        function getCurrentQuizId(){
            const active = document.getElementsByClassName('quiz-card-active')[0];
            if(!active) return null;
            const id = active.id.replace('quiz-','');
            return parseInt(id);
        }

        function persistState(extra){
            const current_quiz_id = extra && extra.current_quiz_id ? extra.current_quiz_id : getCurrentQuizId();
            const state = {
                seconds,
                current_quiz_id,
                selected_options,
            };
            try { localStorage.setItem(stateKey, JSON.stringify(state)); } catch(e) {}
        }

        function restoreState(){
            try {
                const raw = localStorage.getItem(stateKey);
                if(!raw) return;
                const state = JSON.parse(raw);
                if(state.seconds){ seconds = state.seconds; renderTimer(); }
                if(Array.isArray(state.selected_options)){
                    selected_options = state.selected_options;
                    // Re-apply visual selections
                    for(const optId of selected_options){
                        const btn = document.getElementById('quiz-option-' + optId);
                        if(!btn) continue;
                        const qid = parseInt(btn.getAttribute('data-quiz-id'));
                        const ansId = parseInt(document.getElementById('quiz-' + qid).getAttribute('data-answer-id'));
                        applySelection(qid, optId, ansId);
                    }
                }
                if(state.current_quiz_id){ goToQuiz(state.current_quiz_id); }
                // If all questions are already answered, auto-submit to analysis
                if(Array.isArray(selected_options) && selected_options.length === quizzes_count){
                    clearState();
                    document.getElementById('spent_seconds').value = seconds;
                    document.getElementById('selected_options').value = selected_options.join(',');
                    document.getElementById('form').submit();
                }
            } catch(e) {}
        }

        function clearState(){
            try {
                // Remove the exact state key for this user+theme
                localStorage.removeItem(stateKey);
                // Also clean up any leftover progress keys for this user across themes
                const prefix = `test_state_{{ user.id }}_`;
                const toRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(prefix)) toRemove.push(k);
                }
                for (const k of toRemove) localStorage.removeItem(k);
            } catch(e) {}
        }

        // Back handling
        function onBackClick(){
            stopTimer();
            const modal = new bootstrap.Modal(document.getElementById('exitModal'));
            modal.show();
        }
        function resumeTimer(){
            startTimer();
        }
        function confirmExit(){
            // Keep state saved, navigate back to theme detail
            stopTimer();
            persistState();
            const form = document.createElement('form');
            form.style.display = 'none';
            form.method = 'post';
            form.action = '/bot/themes/{{ theme.id }}/';
            const uid = document.createElement('input');
            uid.type = 'hidden';
            uid.name = 'user_id';
            uid.value = '{{ user.id }}';
            form.appendChild(uid);
            document.body.appendChild(form);
            form.submit();
        }

        // Telegram native back button
        if (webApp) { try { webApp.BackButton.show(); webApp.BackButton.onClick(onBackClick); } catch(e) {} }

        // Restore previous state if any
        restoreState();

        // Swipe navigation between quizzes (mobile)
        (function(){
            const el = document.getElementById('body');
            if(!el) return;
            let startX = 0, startY = 0;
            el.addEventListener('touchstart', function(e){
                if(!e.changedTouches || !e.changedTouches[0]) return;
                startX = e.changedTouches[0].clientX;
                startY = e.changedTouches[0].clientY;
            }, { passive: true });
            el.addEventListener('touchend', function(e){
                if(!e.changedTouches || !e.changedTouches[0]) return;
                const dx = e.changedTouches[0].clientX - startX;
                const dy = e.changedTouches[0].clientY - startY;
                if(Math.abs(dx) > 60 && Math.abs(dy) < 50){
                    if(dx < 0){
                        goToNextQuiz();
                    } else {
                        goToPrevQuiz();
                    }
                }
            }, { passive: true });
        })();

        if (webApp) { try { webApp.enableClosingConfirmation(); } catch(e) {} }
    </script>
  </body>
</html>

