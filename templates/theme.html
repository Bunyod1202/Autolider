<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ theme.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-md-center">
        <div class="col-md-auto">
            <div class="row d-flex justify-content-between align-items-center">
                <div class="col-8">
                    <div class="d-flex align-items-center gap-2 mt-3">
                        <a href="/bot/themes/?user_id={{ user.id }}" class="btn btn-outline-secondary btn-sm">{{ user.text.back }}</a>
                        <h1 class="m-0">{{ theme.name }}</h1>
                    </div>
                    <span class="text-muted">{{ user.text.total_quizzes_count }} {{ theme.quizzes_count }}</span>
                </div>
                <div class="col-4 text-end">
                    {% if user.is_active %}
                    <button id="start-or-continue-btn" class="btn btn-primary" type="button" onclick="onStartClick()">{{ user.text.start_testing }}</button>
                    {% else %}
                        <button class="btn btn-primary" type="button" onclick="youAreNotActive()">{{ user.text.start_testing }}</button>
                    {% endif %}
                </div>
            </div>
            <hr/>
            {% for test in tests %}
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">ID{{ test.id }} {{ user.text.test_result }}</h5>
                <p class="card-text">
                    {{ user.text.theme }} <b>{{ theme.name }}</b><br/>
                    {{ user.text.spent_time }} <b>{{ test.spent_time }}</b><br/>
                    {{ user.text.correct_answers }} <b>{{ test.correct_answers }}</b><br/>
                </p>
                <p class="card-text"><small class="text-muted">{{ test.added_time }}</small></p>
                <button class="btn btn-primary" type="submit" form="form" formaction="/bot/test/{{ test.id }}/" formmethod="post">{{ user.text.see_more }}</button>
              </div>
            </div>
            {% empty %}
            <div class="card">
              <div class="card-body text-center">
                  {{ user.text.tests_not_found }}
              </div>
            </div>
            {% endfor %}
        </div>
      </div>
    </div>
    <form style="display: none;" id="form">
        <input type="hidden" name="user_id" value="{{ user.id }}">
        <input type="hidden" name="theme_id" value="{{ theme.id }}">
    </form>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script type="text/javascript">
        // Show a friendly alert via Telegram WebApp if available, otherwise browser alert
        function youAreNotActive(){
            const msg = "{{ user.text.you_are_not_active | safe }}";
            try {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.showAlert){
                    window.Telegram.WebApp.showAlert(msg);
                } else {
                    alert(msg);
                }
            } catch (e) { alert(msg); }
        }

        const stateKey = `test_state_{{ user.id }}_{{ theme.id }}`;
        function onStartClick(){
            // If there is saved progress, keep it so test.html can restore it.
            // If there is no saved progress, nothing to clear.
            let form = document.getElementById("form");
            form.action = "/bot/test/";
            form.method = "post";
            form.submit();
        }

        function goToTest(test_id){
            let form = document.getElementById("form");
            form.action = "/bot/test/" + test_id + "/";
            form.method = "post";
            form.submit();
        }

        function goBack(){
            // Navigate back to themes list within the WebApp
            const url = `/bot/themes/?user_id={{ user.id }}`;
            window.location.href = url;
        }

        const webApp = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (webApp) { try { webApp.expand(); } catch (e) {} }
        // Show Telegram-native back button and handle click
        if (webApp) {
            try {
                webApp.BackButton.show();
                webApp.BackButton.onClick(goBack);
            } catch (e) {
                // no-op if Telegram object unavailable
            }
        }

        // If saved progress exists, change button label to "Continue"
        (function(){
            try {
                const saved = localStorage.getItem(stateKey);
                if(saved){
                    const btn = document.getElementById('start-or-continue-btn');
                    if(btn){ btn.textContent = "{{ user.text.continue_label|default:'Davom etish' }}"; }
                }
            } catch(e) {}
        })();
    </script>
  </body>
</html>
